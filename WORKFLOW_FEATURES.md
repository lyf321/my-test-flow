# 工作流编辑器功能说明

## 功能概述

基于 Vue Flow 实现的工作流编辑器，支持 XR 系统的场景编排功能。

## 节点类型

### 1. 开始节点（Start）
- **图标**: ▶
- **颜色**: 蓝色 (#4d53e8)
- **连线规则**: 
  - 只能有一条出线
  - 不能有入线
  - 可以连接到：大场景、入戏引导

### 2. 结束节点（End）
- **图标**: ■
- **颜色**: 蓝色 (#4d53e8)
- **连线规则**:
  - 不能有出线
  - 可以有多条入线

### 3. 大场景节点（Big Scene）
- **图标**: 🎬
- **颜色**: 蓝色 (#4d53e8)
- **特性**:
  - 支持小场景管理
  - 点击节点可在右侧边栏查看和编辑小场景
  - 可以添加、删除小场景
- **连线规则**:
  - 可以有多条入线和出线
  - 可以连接到：大场景、入戏引导、出戏引导、结束

### 4. 入戏引导节点（Enter Guide）
- **图标**: →
- **颜色**: 绿色 (#10b981)
- **连线规则**:
  - 只能有一条出线
  - 可以有多条入线
  - 只能连接到：大场景

### 5. 出戏引导节点（Exit Guide）
- **图标**: ←
- **颜色**: 橙色 (#f59e0b)
- **连线规则**:
  - 只能有一条出线
  - 可以有多条入线
  - 可以连接到：大场景、结束

## 界面布局

### 右上角操作栏
1. **新增节点**: 在画布中心弹出节点选择器，可选择添加任意节点类型
2. **整理节点**: 自动按层次布局排列所有节点

### 右下角控制栏
1. **回到选中节点** (🎯): 将视图聚焦到当前选中的节点
2. **缩小** (−): 缩小画布视图
3. **缩放比例显示**: 显示当前缩放百分比
4. **放大** (+): 放大画布视图

### 右侧边栏
- 点击大场景节点时自动打开
- 显示小场景列表
- 支持添加和删除小场景
- 显示节点基本信息

## 交互功能

### 1. 节点选中
- 点击节点进行选中
- 选中的大场景节点会在右侧显示详情边栏
- 选中的节点会显示高亮效果

### 2. 添加节点
#### 方式一：从节点添加
- 选中没有后续节点的节点时，右侧会显示加号按钮
- 点击加号弹出节点选择器
- 根据当前节点类型，只显示可连接的节点类型
- 选择节点类型后自动创建节点和连线

#### 方式二：从连线添加
- 鼠标悬停在连线上时，连线中点会显示加号按钮
- 点击加号弹出节点选择器
- 只能选择"大场景"节点
- 新节点会插入到连线中间，原连线被拆分为两条

#### 方式三：从操作栏添加
- 点击右上角"新增节点"按钮
- 在画布中心弹出节点选择器
- 可选择任意节点类型

### 3. 连线规则验证
系统会自动验证以下规则：
- 不能自连接（节点不能连接到自己）
- 不能重复连线（相同源和目标只能有一条连线）
- 不能形成循环（防止死循环）
- 节点类型连接限制（根据业务规则）
- 特殊节点的连线数量限制

### 4. 节点整理
- 点击"整理节点"按钮
- 使用层次布局算法自动排列节点
- 按照连线关系计算层级
- 自动调整节点位置，使布局更清晰

### 5. 小场景管理（大场景节点专属）
- 点击大场景节点打开右侧边栏
- 点击"+ 添加小场景"按钮添加新的小场景
- 每个小场景显示序号、名称和描述
- 点击删除按钮（×）可删除小场景
- 小场景数量会显示在节点上

## 快捷键

- `Ctrl/Cmd + Z`: 撤销
- `Ctrl/Cmd + Shift + Z`: 重做
- `Delete/Backspace`: 删除选中的节点

## 技术特性

### 自动对齐
- 节点拖拽时自动对齐到 20×20 网格
- 提供视觉对齐辅助

### 历史记录
- 支持撤销/重做功能
- 记录所有节点和连线的变化

### 视图控制
- 支持缩放（0.2x - 4x）
- 支持平移
- 支持自动适应视图

### 连线动画
- 连线采用平滑曲线（smoothstep）
- 鼠标悬停时显示加号按钮
- 连线颜色与节点类型对应

## 使用建议

1. **创建工作流**:
   - 从开始节点开始
   - 使用加号按钮逐步添加节点
   - 系统会自动验证连线规则

2. **管理大场景**:
   - 点击大场景节点打开侧边栏
   - 添加相关的小场景
   - 为每个小场景添加描述

3. **优化布局**:
   - 手动拖拽节点调整位置
   - 使用"整理节点"功能自动优化布局
   - 使用缩放和平移功能查看全局

4. **连线编辑**:
   - 悬停在连线上可在中间插入节点
   - 只能插入大场景节点
   - 系统会自动拆分连线

## 注意事项

1. 连线规则严格验证，不符合规则的连接会被阻止
2. 删除节点会同时删除相关的连线
3. 开始节点和入戏/出戏引导节点只能有一条出线
4. 结束节点不能有出线
5. 在连线中间只能插入大场景节点

